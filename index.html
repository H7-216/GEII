<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simulateur UE - BUT GEII</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Courier+Prime&display=swap" rel="stylesheet">
    <style>
      body { font-family: 'Inter', sans-serif; }
      .font-mono { font-family: 'Courier Prime', monospace; }
    </style>
    <script>
        tailwind.config = {
          theme: {
            extend: {
              colors: {
                primary: '#3B82F6',
                surface: '#FAFAFA',
                border: '#E5E5E5',
                'text-primary': '#1F2937',
                'text-secondary': '#666666',
              }
            }
          }
        }
    </script>
  </head>
  <body class="bg-gray-50 text-gray-900 antialiased">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // --- DATA ---
      const SEMESTERS = [
        {
          id: "S3",
          name: "Semestre 3",
          ues: ["UE31", "UE32", "UE33", "UE34"],
          groups: [
            {
              name: "Ressources transversales (UE31 et 32)",
              subjects: [
                {
                  code: "TBITR301", name: "Anglais", coeffTotal: 48,
                  subGrades: [
                    { name: "DS", coeff: 18 }, { name: "Implication", coeff: 10 },
                    { name: "CO", coeff: 10 }, { name: "Oral", coeff: 10 },
                  ],
                  ueCoeffs: { UE31: 24, UE32: 24, UE33: 0, UE34: 0 },
                },
                {
                  code: "TBITR302", name: "Culture et communication", coeffTotal: 48,
                  subGrades: [
                    { name: "Note de séance", coeff: 12 }, { name: "DS", coeff: 18 }, { name: "Exposé", coeff: 18 },
                  ],
                  ueCoeffs: { UE31: 24, UE32: 24, UE33: 0, UE34: 0 },
                },
                {
                  code: "TBITR303", name: "Vie de l'entreprise", coeffTotal: 16,
                  subGrades: [{ name: "Séance", coeff: 16 }],
                  ueCoeffs: { UE31: 8, UE32: 8, UE33: 0, UE34: 0 },
                },
                {
                  code: "TBITR304", name: "Outils Mathématiques et Logiciels", coeffTotal: 72,
                  subGrades: [
                    { name: "DS1", coeff: 26 }, { name: "DS2", coeff: 26 }, { name: "Seance", coeff: 20 },
                  ],
                  ueCoeffs: { UE31: 36, UE32: 36, UE33: 0, UE34: 0 },
                },
                {
                  code: "TBITR310", name: "Physique appliquée", coeffTotal: 48,
                  subGrades: [
                    { name: "DS1", coeff: 13 }, { name: "DS2", coeff: 13 },
                    { name: "Partiel TP", coeff: 13 }, { name: "séance", coeff: 9 },
                  ],
                  ueCoeffs: { UE31: 24, UE32: 24, UE33: 0, UE34: 0 },
                },
                {
                  code: "TBITR305", name: "Projet personnel et professionnel", coeffTotal: 8,
                  subGrades: [{ name: "Candidature", coeff: 8 }],
                  ueCoeffs: { UE31: 4, UE32: 4, UE33: 0, UE34: 0 },
                },
              ],
            },
            {
              name: "Ressources métiers (UE33 et 34)",
              subjects: [
                {
                  code: "TBITR306", name: "Automatique", coeffTotal: 50,
                  subGrades: [{ name: "DS", coeff: 25 }, { name: "TP", coeff: 25 }],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 25, UE34: 25 },
                },
                {
                  code: "TBITR307", name: "Informatique Industrielle", coeffTotal: 72,
                  subGrades: [{ name: "DS", coeff: 36 }, { name: "Partiel TP", coeff: 36 }],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 36, UE34: 36 },
                },
                {
                  code: "TBITR308", name: "Electronique (analogique)", coeffTotal: 48,
                  subGrades: [{ name: "DS", coeff: 32 }, { name: "TP", coeff: 16 }],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 24, UE34: 24 },
                },
                {
                  code: "TBITR309", name: "Energie", coeffTotal: 72,
                  subGrades: [
                    { name: "DS1", coeff: 18 }, { name: "DS2", coeff: 18 },
                    { name: "TP", coeff: 18 }, { name: "Quiz/WIMS", coeff: 18 },
                  ],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 36, UE34: 36 },
                },
                {
                  code: "TBITR311", name: "Maintenance", coeffTotal: 16,
                  subGrades: [{ name: "DS", coeff: 16 }],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 8, UE34: 8 },
                },
                {
                  code: "TBITR312", name: "Réseaux et cybersécurité", coeffTotal: 34,
                  subGrades: [
                    { name: "DS", coeff: 14 }, { name: "Partiel TP", coeff: 14 },
                    { name: "Seance TP/TD", coeff: 6 },
                  ],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 17, UE34: 17 },
                },
                {
                  code: "TBITR315", name: "Supervision/ Télégestion", coeffTotal: 34,
                  subGrades: [{ name: "DS", coeff: 26 }, { name: "TP", coeff: 8 }],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 17, UE34: 17 },
                },
                {
                  code: "TBITR3A1", name: "Electronique (numérique)", coeffTotal: 34,
                  subGrades: [{ name: "DS", coeff: 12 }, { name: "Partiel TP", coeff: 20 }],
                  ueCoeffs: { UE31: 0, UE32: 0, UE33: 17, UE34: 17 },
                },
              ],
            },
            {
              name: "Pôle SAE (UE31,32,33 et 34)",
              subjects: [
                {
                  code: "TBITE301", name: "Saé LoRa", coeffTotal: 200,
                  subGrades: [
                    { name: "SEANCE", coeff: 80 }, { name: "RAPPORT", coeff: 50 }, { name: "PARTIEL TP", coeff: 70 },
                  ],
                  ueCoeffs: { UE31: 40, UE32: 40, UE33: 60, UE34: 60 },
                },
                {
                  code: "TBITE302", name: "Saé Four", coeffTotal: 200,
                  subGrades: [
                    { name: "SEANCE", coeff: 70 }, { name: "EVAL", coeff: 65 }, { name: "DS", coeff: 65 },
                  ],
                  ueCoeffs: { UE31: 40, UE32: 40, UE33: 60, UE34: 60 },
                },
              ],
            },
          ],
        },
        {
          id: "S4",
          name: "Semestre 4",
          ues: ["UE41", "UE42", "UE43", "UE44"],
          groups: [
            {
              name: "Ressources transversales (UE41 et 42)",
              subjects: [
                {
                  code: "TBITR401", name: "Anglais", coeffTotal: 36,
                  subGrades: [
                    { name: "DS", coeff: 18 }, { name: "Débat", coeff: 9 }, { name: "CO", coeff: 9 },
                  ],
                  ueCoeffs: { UE41: 18, UE42: 18, UE43: 0, UE44: 0 },
                },
                {
                  code: "TBITR402", name: "Culture et communication", coeffTotal: 36,
                  subGrades: [{ name: "Eval", coeff: 18 }, { name: "Vidéo", coeff: 18 }],
                  ueCoeffs: { UE41: 18, UE42: 18, UE43: 0, UE44: 0 },
                },
                {
                  code: "TBITR403", name: "Vie de l'entreprise", coeffTotal: 28,
                  subGrades: [{ name: "DS", coeff: 28 }],
                  ueCoeffs: { UE41: 14, UE42: 14, UE43: 0, UE44: 0 },
                },
                {
                  code: "TBITR404", name: "Outils Mathématiques et Logiciels", coeffTotal: 48,
                  subGrades: [
                    { name: "DS1", coeff: 18 }, { name: "DS2", coeff: 18 }, { name: "Note de séance", coeff: 12 },
                  ],
                  ueCoeffs: { UE41: 24, UE42: 24, UE43: 0, UE44: 0 },
                },
                {
                  code: "TBITR405", name: "Projet personnel et professionnel", coeffTotal: 12,
                  subGrades: [
                    { name: "Séance", coeff: 8 }, { name: "Recherche de contrat", coeff: 4 },
                  ],
                  ueCoeffs: { UE41: 6, UE42: 6, UE43: 0, UE44: 0 },
                },
              ],
            },
            {
              name: "Ressources métiers (UE43 et 44)",
              subjects: [
                {
                  code: "TBITR4IA", name: "Bases de l'IA pour l'IoT", coeffTotal: 72,
                  subGrades: [{ name: "DS", coeff: 48 }, { name: "Note de séance", coeff: 24 }],
                  ueCoeffs: { UE41: 0, UE42: 0, UE43: 36, UE44: 36 },
                },
                {
                  code: "TBITM407", name: "Energie spécialisée", coeffTotal: 72,
                  subGrades: [
                    { name: "DS", coeff: 30 }, { name: "TP", coeff: 21 }, { name: "Quiz/WIMS", coeff: 21 },
                  ],
                  ueCoeffs: { UE41: 0, UE42: 0, UE43: 36, UE44: 36 },
                },
                {
                  code: "TBITR406", name: "Automatique", coeffTotal: 54,
                  subGrades: [{ name: "DS", coeff: 27 }, { name: "TP", coeff: 27 }],
                  ueCoeffs: { UE41: 0, UE42: 0, UE43: 27, UE44: 27 },
                },
                {
                  code: "TBITR4A1", name: "Automatisme spécialisé", coeffTotal: 54,
                  subGrades: [{ name: "DS", coeff: 27 }, { name: "TP", coeff: 27 }],
                  ueCoeffs: { UE41: 0, UE42: 0, UE43: 27, UE44: 27 },
                },
                {
                  code: "TBITR4A2", name: "Electronique spécialisée", coeffTotal: 54,
                  subGrades: [{ name: "DS", coeff: 36 }, { name: "TP", coeff: 18 }],
                  ueCoeffs: { UE41: 0, UE42: 0, UE43: 27, UE44: 27 },
                },
                {
                  code: "TBITR4A3", name: "Electronique (numérique)", coeffTotal: 54,
                  subGrades: [{ name: "Evaluation", coeff: 54 }],
                  ueCoeffs: { UE41: 0, UE42: 0, UE43: 27, UE44: 27 },
                },
              ],
            },
            {
              name: "Pôle SAE (UE41, 42, 43 et 44)",
              subjects: [
                {
                  code: "TBITM401", name: "Saé Roue", coeffTotal: 200,
                  subGrades: [
                    { name: "DS1", coeff: 68 }, { name: "SEANCE", coeff: 68 }, { name: "DOSSIER", coeff: 54 },
                  ],
                  ueCoeffs: { UE41: 50, UE42: 50, UE43: 50, UE44: 50 },
                },
                {
                  code: "TBITM4ST", name: "Stage", coeffTotal: 272,
                  subGrades: [
                    { name: "Entreprise", coeff: 90 }, { name: "Soutenance orale", coeff: 85 },
                    { name: "Rapport", coeff: 85 }, { name: "Recherche de Stage", coeff: 12 },
                  ],
                  ueCoeffs: { UE41: 68, UE42: 68, UE43: 68, UE44: 68 },
                },
                {
                  code: "TBITME4PF", name: "Portfolio", coeffTotal: 8,
                  subGrades: [{ name: "Séance", coeff: 8 }],
                  ueCoeffs: { UE41: 2, UE42: 2, UE43: 2, UE44: 2 },
                },
              ],
            },
          ],
        },
      ];

      // --- ICONS ---
      // Simple Lucide wrappers using the global lucide object
      const Icon = ({ name, className }) => {
        useEffect(() => {
          lucide.createIcons();
        }, [name]);
        return <i data-lucide={name} className={className}></i>;
      };

      // --- COMPONENTS ---

      function UECard({ ueId, subjects, grades }) {
        const contributingSubjects = subjects.filter((s) => (s.ueCoeffs[ueId] || 0) > 0);

        let totalWeightedPoints = 0;
        let totalUECoeffs = 0;
        let totalSubjectCount = contributingSubjects.length;
        let filledSubjectCount = 0;

        contributingSubjects.forEach((subj) => {
          const ueCoeff = subj.ueCoeffs[ueId];
          let subPoints = 0;
          let subCoeffs = 0;
          let subFilled = 0;
          
          subj.subGrades.forEach(g => {
            const val = grades[subj.code]?.[g.name];
            if (val !== undefined && !isNaN(val)) {
              subPoints += val * g.coeff;
              subFilled++;
            }
            subCoeffs += g.coeff;
          });

          const subjAvg = subCoeffs > 0 ? subPoints / subCoeffs : 0;
          if (subFilled === subj.subGrades.length) {
            filledSubjectCount++;
          }

          totalWeightedPoints += subjAvg * ueCoeff;
          totalUECoeffs += ueCoeff;
        });

        const ueAverage = totalUECoeffs > 0 ? totalWeightedPoints / totalUECoeffs : 0;
        const progress = Math.round((filledSubjectCount / totalSubjectCount) * 100);
        const isValidated = ueAverage >= 10;

        return (
          <div className="bg-white border border-border rounded-xl p-5 shadow-sm flex flex-col h-full relative overflow-hidden group hover:shadow-md transition-shadow duration-300">
            <div className="absolute top-0 left-0 w-1 h-full bg-primary/20 group-hover:bg-primary transition-colors"></div>
            
            <div className="flex justify-between items-start mb-4 pl-2">
              <div>
                <h3 className="text-lg font-bold text-text-primary">{ueId}</h3>
                <p className="text-xs text-text-secondary mt-1">
                  {filledSubjectCount}/{totalSubjectCount} matières complétées
                </p>
              </div>
              <div className={`flex items-center justify-center w-10 h-10 rounded-full ${isValidated ? 'text-green-600 bg-green-50' : 'text-orange-500 bg-orange-50'}`}>
                <Icon name={isValidated ? "check-circle-2" : "alert-circle"} className="w-5 h-5" />
              </div>
            </div>

            <div className="mt-auto pl-2">
              <div className="flex items-end gap-2 mb-1">
                <span className={`text-3xl font-bold font-mono tracking-tight ${isValidated ? 'text-green-600' : 'text-orange-500'}`}>
                  {ueAverage.toFixed(2)}
                </span>
                <span className="text-sm text-text-secondary mb-1.5">/ 20</span>
              </div>
              
              <div className="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mt-3">
                <div 
                  className="h-full bg-primary transition-all duration-500 ease-out"
                  style={{ width: `${progress}%` }}
                ></div>
              </div>
            </div>
          </div>
        );
      }

      function SubjectRow({ subject, grades, onGradeChange }) {
        const [isExpanded, setIsExpanded] = useState(false);

        let totalPoints = 0;
        let totalCoeffs = 0;
        let filledGrades = 0;

        subject.subGrades.forEach((sub) => {
          const grade = grades[sub.name];
          if (grade !== undefined && !isNaN(grade)) {
            totalPoints += grade * sub.coeff;
            filledGrades++;
          }
          totalCoeffs += sub.coeff;
        });

        const hasAnyGrade = filledGrades > 0;
        const displayAverage = hasAnyGrade 
          ? (totalPoints / totalCoeffs).toFixed(2) 
          : "-";
        const isComplete = filledGrades === subject.subGrades.length;

        return (
          <div className={`bg-white border border-border rounded-lg overflow-hidden transition-all duration-200 ${isExpanded ? 'shadow-md ring-1 ring-primary/10' : 'hover:bg-surface hover:shadow-sm'}`}>
            <div 
              className="p-4 cursor-pointer grid grid-cols-[1fr_auto_auto] items-center gap-4"
              onClick={() => setIsExpanded(!isExpanded)}
            >
              <div className="flex flex-col">
                <div className="flex items-center gap-2">
                  <span className="font-mono text-xs font-bold text-primary/80 bg-primary/5 px-2 py-0.5 rounded">
                    {subject.code}
                  </span>
                  <h3 className="font-medium text-text-primary">{subject.name}</h3>
                </div>
                <div className="text-xs text-text-secondary mt-1 flex gap-2">
                  <span>Coeff: {subject.coeffTotal}</span>
                  {isComplete && <span className="text-green-600 flex items-center gap-1"><Icon name="check" className="w-3 h-3" /> Complet</span>}
                </div>
              </div>

              <div className="flex flex-col items-end min-w-[80px]">
                <span className="text-xs text-text-secondary uppercase tracking-wider">Moyenne</span>
                <span className={`font-mono text-lg font-bold ${hasAnyGrade ? (Number(displayAverage) >= 10 ? "text-green-600" : "text-orange-500") : "text-text-secondary/50"}`}>
                  {displayAverage}
                </span>
              </div>

              <div className="text-text-secondary">
                <Icon name={isExpanded ? "chevron-up" : "chevron-down"} className="w-5 h-5" />
              </div>
            </div>

            {isExpanded && (
              <div className="border-t border-border bg-gray-50/50 p-4 animate-[fadeIn_0.2s_ease-out]">
                <div className="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
                  {subject.subGrades.map((sub) => (
                    <div key={sub.name} className="flex flex-col gap-1.5">
                      <label className="text-xs font-medium text-text-secondary flex justify-between">
                        <span>{sub.name}</span>
                        <span className="text-text-secondary/70 text-[10px]">Coeff {sub.coeff}</span>
                      </label>
                      <input
                        type="number"
                        min="0"
                        max="20"
                        step="0.1"
                        placeholder="-"
                        className={`w-full bg-white border rounded px-3 py-2 text-sm font-mono focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all ${grades[sub.name] !== undefined ? 'border-primary/50 text-primary' : 'border-border'}`}
                        value={grades[sub.name] ?? ""}
                        onChange={(e) => {
                          const val = e.target.value;
                          onGradeChange(sub.name, val === "" ? NaN : parseFloat(val));
                        }}
                        onClick={(e) => e.stopPropagation()}
                      />
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      }

      function App() {
        const [activeSemesterId, setActiveSemesterId] = useState("S3");
        const [grades, setGrades] = useState({});

        // Load from local storage on mount
        useEffect(() => {
          const savedGrades = localStorage.getItem('ue-grades');
          if (savedGrades) {
            try {
              setGrades(JSON.parse(savedGrades));
            } catch (e) { console.error("Failed to load grades", e); }
          }
        }, []);

        // Save to local storage on change
        useEffect(() => {
          localStorage.setItem('ue-grades', JSON.stringify(grades));
        }, [grades]);

        const activeSemester = SEMESTERS.find(s => s.id === activeSemesterId) || SEMESTERS[0];
        const allSubjects = activeSemester.groups.flatMap(g => g.subjects);

        const handleGradeChange = (subjectCode, subGradeName, value) => {
          setGrades((prev) => ({
            ...prev,
            [subjectCode]: {
              ...prev[subjectCode],
              [subGradeName]: value,
            },
          }));
        };

        return (
          <div className="min-h-screen pb-20">
            <header className="bg-white border-b border-border sticky top-0 z-50 shadow-sm backdrop-blur-md bg-white/80">
              <div className="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 bg-primary text-white rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                    <Icon name="graduation-cap" className="w-6 h-6" />
                  </div>
                  <div>
                    <h1 className="font-bold text-lg leading-none text-text-primary">Simulateur UE</h1>
                    <p className="text-xs text-text-secondary mt-1">BUT GEII</p>
                  </div>
                </div>

                <div className="flex p-1 bg-gray-100 rounded-lg border border-border">
                  {SEMESTERS.map((sem) => (
                    <button
                      key={sem.id}
                      onClick={() => setActiveSemesterId(sem.id)}
                      className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all duration-200 ${activeSemesterId === sem.id ? 'bg-white text-primary shadow-sm ring-1 ring-black/5' : 'text-text-secondary hover:text-text-primary hover:bg-black/5'}`}
                    >
                      {sem.name}
                    </button>
                  ))}
                </div>
              </div>
            </header>

            <main className="max-w-5xl mx-auto px-4 py-8">
              <div className="mb-8">
                <h1 className="text-2xl font-bold text-text-primary mb-2">
                  Tableau de Bord {activeSemester.name}
                </h1>
                <p className="text-text-secondary max-w-2xl">
                  Saisissez vos notes ci-dessous pour calculer automatiquement vos moyennes d'UE et valider votre semestre.
                </p>
              </div>

              <div className="space-y-8 animate-[fadeIn_0.5s_ease-out]">
                {/* UEs */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  {activeSemester.ues.map((ueId) => (
                    <UECard 
                      key={ueId} 
                      ueId={ueId} 
                      subjects={allSubjects} 
                      grades={grades} 
                    />
                  ))}
                </div>

                {/* Groups */}
                <div className="space-y-8">
                  {activeSemester.groups.map((group) => (
                    <section key={group.name} className="space-y-4">
                      <div className="flex items-center gap-3">
                        <h2 className="text-lg font-bold text-text-primary tracking-tight">
                          {group.name}
                        </h2>
                        <div className="h-px flex-1 bg-border"></div>
                      </div>
                      
                      <div className="grid gap-3">
                        {group.subjects.map((subject) => (
                          <SubjectRow
                            key={subject.code}
                            subject={subject}
                            grades={grades[subject.code] || {}}
                            onGradeChange={(name, val) => handleGradeChange(subject.code, name, val)}
                          />
                        ))}
                      </div>
                    </section>
                  ))}
                </div>
              </div>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>